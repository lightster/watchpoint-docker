install: ${INSTALL_TARGET}

install-docker: build-compose-file
	docker-compose build
	docker-compose up -d

install-dev: codebase/pickem codebase-update build-nginx-conf install-docker release .install-db run-migrations

install-pier: install-dev

codebase/pickem:
	git clone git@github.com:lightster/watchpoint-pickem.git codebase/pickem

codebase-update:
	cd codebase/pickem && git pull

build-nginx-conf:
	cp docker/nginx/dist/* docker/nginx/conf.d/

build-compose-file:
	cp -a docker/docker-compose.*.yml .
	docker-compose $(COMPOSE_FILES) config >docker-compose.yml
	rm docker-compose.*.yml

release: build-release link-release

build-release:
	docker-compose run --rm -w /opt/pickem-releases/${VERSION} php-fpm composer install --no-dev

link-release:
	docker-compose run --rm -w /opt/pickem-releases/ php-fpm ln -sfn ${VERSION} current
