define ENV_CONTENT
DB_URL=postgres://watchpoint:watchpoint@postgres:5432/watchpoint?application_name=watchpoint-app
BNET_API_KEY=$(BNET_API_KEY)
BNET_API_SECRET=$(BNET_API_SECRET)
POSTGRES_USER=watchpoint
POSTGRES_PASSWORD=watchpoint
endef
export ENV_CONTENT

install: ${INSTALL_TARGET}

install-docker: build-compose-file
	docker-compose build
	docker-compose up -d

install-dev: codebase/pickem codebase-update build-nginx-conf install-docker release run-migrations

install-pier: install-dev

.install-db:
	docker-compose run --rm -w /opt/pickem-releases/current php-fpm bin/wpt migrate:setup
	touch .install-db

run-migrations: .install-db
	docker-compose run --rm -w /opt/pickem-releases/current php-fpm bin/wpt migrate

codebase/pickem:
	git clone git@github.com:lightster/watchpoint-pickem.git codebase/pickem

codebase-update:
	@echo "$$ENV_CONTENT" >.env
	cd codebase/pickem && git pull

build-nginx-conf:
	cp docker/nginx/dist/* docker/nginx/conf.d/

build-compose-file:
	cp -a docker/docker-compose.*.yml .
	docker-compose $(COMPOSE_FILES) config >docker-compose.yml
	rm docker-compose.*.yml

release: build-release run-migrations link-release

build-release:
	docker-compose run --rm -w /opt/pickem-releases/${VERSION} php-fpm composer install --no-dev

link-release:
	docker-compose run --rm -w /opt/pickem-releases/ php-fpm ln -sfn ${VERSION} current
